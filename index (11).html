<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bol√£o Loteria Federal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.hidden{display:none}
.container{
  max-width:380px;
  margin:40px auto;
  background:#111;
  padding:22px;
  border-radius:14px;
  text-align:center;
}
.sala{
  max-width:800px;
  margin:auto;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:15px;
}
input{background:#1e1e1e;color:#fff}
button{background:#00e676;color:#000;font-weight:bold;cursor:pointer}
.status{margin-top:10px}
.qr img{width:220px;margin-top:10px}
.pix-box{display:flex;gap:6px;margin-top:8px}
.pix-box input{flex:1;background:#1e1e1e;color:#0f0;font-size:13px}
#countdown{margin-top:10px;font-weight:bold;color:#ffd54f}

.checkmark{
  font-size:60px;
  color:#00e676;
  animation:pop .6s ease;
}
@keyframes pop{
  0%{transform:scale(0);opacity:0}
  80%{transform:scale(1.2)}
  100%{transform:scale(1);opacity:1}
}

.card{
  background:#121212;
  border-radius:12px;
  padding:16px;
  margin-bottom:15px;
}
ul li{
  background:#1e1e1e;
  padding:8px;
  border-radius:6px;
  margin-bottom:6px;
}
</style>
</head>

<body>

<!-- LOGIN / PIX -->
<div class="container" id="loginArea">
  <h2>üéüÔ∏è Bol√£o Loteria Federal</h2>

  <input id="nome" placeholder="Seu nome completo">
  <input id="telefone" placeholder="Telefone / WhatsApp">

  <button onclick="gerarPix()">GERAR PIX</button>

  <div class="status" id="status"></div>
  <div class="qr" id="qr"></div>
  <div id="countdown"></div>

  <div id="approved" class="hidden">
    <div class="checkmark">‚úî</div>
    <div>Pagamento aprovado!</div>
  </div>
</div>

<!-- SALA -->
<div class="sala hidden" id="salaBolao">
  <h2>üéâ Sala do Bol√£o</h2>

  <div class="card">
    <h3>üë§ Seus dados</h3>
    <p><strong>Nome:</strong> <span id="meuNome"></span></p>
    <p><strong>Telefone:</strong> <span id="meuTelefone"></span></p>
  </div>

  <div class="card">
    <h3>üë• Participantes</h3>
    <ul id="listaParticipantes"></ul>
  </div>
</div>

<audio id="successSound">
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_4b87d3b3f5.mp3">
</audio>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbyoEzMAJPNQ6fF38lvWAjDdKeLuMHIq88sIJUfRZNPL2jLgi7dQjJbznn2eh4ArInr2/exec';

let paymentId=null;
let tempo=300;
let timer=null;
let nomeCliente='';
let telefoneCliente='';

/* ===== RESTAURAR AO CARREGAR ===== */
window.onload=()=>{
  const saved=JSON.parse(localStorage.getItem('pixData'));
  const auth=JSON.parse(localStorage.getItem('bolao_auth'));

  if(auth){
    nomeCliente=auth.nome;
    telefoneCliente=auth.telefone;
  }

  if(!saved) return;

  paymentId=saved.paymentId;
  nomeCliente=saved.nome;
  telefoneCliente=saved.telefone;

  document.getElementById('nome').value=nomeCliente;
  document.getElementById('telefone').value=telefoneCliente;

  const agora=Math.floor(Date.now()/1000);
  tempo=saved.tempo-(agora-saved.timestamp);
  if(tempo<=0){
    localStorage.removeItem('pixData');
    return;
  }

  document.getElementById('status').innerText='‚è≥ Aguardando pagamento...';
  document.getElementById('qr').innerHTML=`
    <img src="data:image/png;base64,${saved.qr}">
    <div class="pix-box">
      <input id="pixKeyInput" value="${saved.pix}" readonly>
      <button onclick="copiarPix()">üìã</button>
    </div>
  `;

  iniciarContador();
  iniciarVerificacao();
};

/* ===== GERAR PIX ===== */
function gerarPix(){
  nomeCliente=document.getElementById('nome').value.trim();
  telefoneCliente=document.getElementById('telefone').value.trim();
  const status=document.getElementById('status');

  if(!nomeCliente||!telefoneCliente){
    status.innerText='Preencha todos os dados';
    return;
  }

  status.innerText='Gerando Pix...';

  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'createPayment',nome:nomeCliente,telefone:telefoneCliente})
  })
  .then(r=>r.json())
  .then(data=>{
    paymentId=data.paymentId;
    tempo=300;

    localStorage.setItem('pixData',JSON.stringify({
      paymentId,
      nome:nomeCliente,
      telefone:telefoneCliente,
      pix:data.pixKey,
      qr:data.qrCodeBase64,
      tempo,
      timestamp:Math.floor(Date.now()/1000)
    }));

    document.getElementById('qr').innerHTML=`
      <img src="data:image/png;base64,${data.qrCodeBase64}">
      <div class="pix-box">
        <input id="pixKeyInput" value="${data.pixKey}" readonly>
        <button onclick="copiarPix()">üìã</button>
      </div>
    `;

    status.innerText='‚è≥ Aguardando pagamento...';
    iniciarContador();
    iniciarVerificacao();
  });
}

/* ===== CONTADOR ===== */
function iniciarContador(){
  clearInterval(timer);
  timer=setInterval(()=>{
    const min=String(Math.floor(tempo/60)).padStart(2,'0');
    const sec=String(tempo%60).padStart(2,'0');
    document.getElementById('countdown').innerText=`‚è≥ ${min}:${sec}`;
    tempo--;
  },1000);
}

/* ===== VERIFICAR PAGAMENTO ===== */
function iniciarVerificacao(){
  const check=setInterval(()=>{
    fetch(API_URL,{
      method:'POST',
      body:JSON.stringify({action:'checkPayment',paymentId})
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.status==='PAID'){
        clearInterval(check);
        clearInterval(timer);
        localStorage.removeItem('pixData');

        localStorage.setItem('bolao_auth',JSON.stringify({
          nome:nomeCliente,
          telefone:telefoneCliente,
          expires:Date.now()+86400000
        }));

        aprovado();
      }
    });
  },5000);
}

/* ===== APROVADO ===== */
function aprovado(){
  document.getElementById('successSound').play();
  document.getElementById('approved').classList.remove('hidden');

  setTimeout(()=>{
    entrarNaSala(nomeCliente,telefoneCliente);
  },1500);
}

/* ===== SALA ===== */
function entrarNaSala(nome,telefone){
  document.getElementById('loginArea').classList.add('hidden');
  document.getElementById('salaBolao').classList.remove('hidden');

  document.getElementById('meuNome').innerText=nome;
  document.getElementById('meuTelefone').innerText=telefone;

  carregarParticipantes();
}

function carregarParticipantes(){
  fetch(API_URL+'?action=infoBolao')
  .then(r=>r.json())
  .then(data=>{
    const ul=document.getElementById('listaParticipantes');
    ul.innerHTML='';
    data.participantes.forEach(p=>{
      const li=document.createElement('li');
      li.textContent=p.nome;
      ul.appendChild(li);
    });
  });
}

function copiarPix(){
  const input=document.getElementById('pixKeyInput');
  input.select();
  navigator.clipboard.writeText(input.value);
}
</script>

</body>
</html>
