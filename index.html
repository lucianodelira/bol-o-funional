<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>BolÃ£o Loteria Federal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;

  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
}

.hidden{display:none}

.container{
  max-width:380px;
  width:100%;
  background:#111;
  padding:20px;
  border-radius:14px;

  position:relative;
  z-index:10;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:15px;
}

input{
  background:#1e1e1e;
  color:#fff;
}

button{
  background:#00e676;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}

button.sec{
  background:#2196f3;
  color:#fff;
}

.card{
  background:#121212;
  border-radius:12px;
  padding:16px;
  margin-bottom:15px;
}

ul{padding:0;list-style:none}

ul li{
  background:#1e1e1e;
  padding:8px;
  border-radius:6px;
  margin-bottom:6px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h2>ğŸ” Login</h2>
  <input id="loginInput" placeholder="Login">
  <input id="senhaInput" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <button class="sec" onclick="mostrarCadastro()">Criar conta</button>
  <p id="msgLogin"></p>
</div>

<!-- CADASTRO -->
<div class="container hidden" id="cadastroBox">
  <h2>ğŸ“ Cadastro</h2>
  <input id="nomeCad" placeholder="Nome completo">
  <input id="telCad" placeholder="Telefone">
  <input id="loginCad" placeholder="Login">
  <input id="senhaCad" type="password" placeholder="Senha">
  <button onclick="cadastrar()">Cadastrar</button>
  <button class="sec" onclick="voltarLogin()">Voltar</button>
  <p id="msgCad"></p>
</div>

<!-- DASH -->
<div class="container hidden" id="dash">
  <h2>ğŸŸï¸ Ãrea do Participante</h2>
  <p><b>Nome:</b> <span id="meuNome"></span></p>
  <p><b>Telefone:</b> <span id="meuTelefone"></span></p>

  <button onclick="participarBolao()">Participar do BolÃ£o (Pix)</button>
  <button class="sec" onclick="logout()">Sair</button>
</div>

<!-- SALA -->
<div class="container hidden" id="sala">
  <h2>ğŸ‰ Sala do BolÃ£o</h2>

  <div class="card">
    <h3>ğŸ‘¥ Participantes</h3>
    <ul id="lista"></ul>
  </div>
</div>

<audio id="ok">
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_4b87d3b3f5.mp3">
</audio>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyoEzMAJPNQ6fF38lvWAjDdKeLuMHIq88sIJUfRZNPL2jLgi7dQjJbznn2eh4ArInr2/exec';

let token = null;
let telefone = null;
let nome = null;
let monitorRef = null;

/* ========= AUTO LOGIN ========= */
window.onload = ()=>{
  const s = JSON.parse(localStorage.getItem('sessao'));
  if(s){
    token = s.token;
    validarSessao();
  }
};

/* ========= LOGIN ========= */
function login(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'login',
      login: document.getElementById('loginInput').value,
      senha: document.getElementById('senhaInput').value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      salvarSessao(d);
      validarSessao();
    }else{
      msgLogin.innerText = d.error;
    }
  });
}

/* ========= CADASTRO ========= */
function cadastrar(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'register',
      nome: nomeCad.value,
      telefone: telCad.value,
      login: loginCad.value,
      senha: senhaCad.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    msgCad.innerText = d.success
      ? 'âœ… Conta criada! FaÃ§a login.'
      : d.error;
  });
}

/* ========= VALIDAR SESSÃƒO ========= */
function validarSessao(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'validateSession',
      token
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.authorized){
      telefone = d.telefone;
      nome = d.nome;
      mostrarDash();
      iniciarMonitor();
    }else logout();
  });
}

/* ========= DASH ========= */
function mostrarDash(){
  loginBox.classList.add('hidden');
  cadastroBox.classList.add('hidden');
  dash.classList.remove('hidden');

  meuNome.innerText = nome;
  meuTelefone.innerText = telefone;
}

/* ========= BOLÃƒO ========= */
function participarBolao(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'validateBolao',
      telefone
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.authorized){
      entrarSala();
    }else{
      alert('ğŸ’³ Gere o Pix no painel ADM para liberar');
    }
  });
}

/* ========= SALA ========= */
function entrarSala(){
  dash.classList.add('hidden');
  sala.classList.remove('hidden');
  carregarParticipantes();
  document.getElementById('ok').play();
}

/* ========= MONITOR ========= */
function iniciarMonitor(){
  if(monitorRef) clearInterval(monitorRef);

  monitorRef = setInterval(()=>{
    fetch(API,{
      method:'POST',
      body:JSON.stringify({
        action:'validateBolao',
        telefone
      })
    })
    .then(r=>r.json())
    .then(d=>{
      if(!d.authorized){
        alert('ğŸš« Acesso removido pelo administrador');
        logout();
      }
    });
  },5000);
}

/* ========= PARTICIPANTES ========= */
function carregarParticipantes(){
  fetch(API+'?action=infoBolao')
  .then(r=>r.json())
  .then(d=>{
    lista.innerHTML='';
    d.participantes.forEach(p=>{
      const li=document.createElement('li');
      li.textContent=p.nome;
      lista.appendChild(li);
    });
  });
}

/* ========= AUX ========= */
function salvarSessao(d){
  localStorage.setItem('sessao',JSON.stringify(d));
  token = d.token;
  nome = d.nome;
  telefone = d.telefone;
}
function logout(){
  localStorage.removeItem('sessao');
  location.reload();
}
function mostrarCadastro(){
  loginBox.classList.add('hidden');
  cadastroBox.classList.remove('hidden');
}
function voltarLogin(){
  cadastroBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
}
</script>

</body>
</html>
